<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Application Présence</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 0;
            background-color: #f0f0f0;
        }
        #app-container {
            max-width: 600px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        }
        input[type=email] {
            width: 95%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        button {
            width: 99%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
            cursor: pointer;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
        }
        th, td {
            padding: 10px;
            border: 1px solid #ccc;
            text-align: center;
        }
        th {
            background-color: #f4f4f4;
        }
        a {
            float: right;
            text-align: right;
            color: blue;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
            color: cadetblue;
        }
        .checkboxes {
            display: flex;
            justify-content: space-around;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #333;
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }
        .toast.success {
            background-color: #4caf50;
        }
        .toast.error {
            background-color: #f44336;
        }
        .toast.warning {
            background-color: #ff9800;
        }
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: #333;
            animation: spin 1s ease-in-out infinite;
            vertical-align: middle;
            margin-left: 10px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        @media (max-width: 768px) {
            #app-container {
                margin: 10px;
                padding: 15px;
            }
            table {
                font-size: 14px;
            }
            th, td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div id="app-container">
        <h2>ADD NEMOURS Manager</h2>

        <!-- Step 1: Email input -->
        <div id="step1">
            <label for="email">Entrez votre email :</label>
            <input
                type="email"
                id="email"
                placeholder="Votre email..."
                required
                aria-label="Adresse email"
                aria-required="true"
            >
            <button onclick="submitEmail()" aria-label="Valider l'email">Valider</button>
        </div>

        <!-- Step 2: Calendar appears -->
        <div id="step2" style="display:none;">
            <a
                href="https://docs.google.com/spreadsheets/d/18rYWWCHPpa3eW3bT7hFvgIhfnsu5lxoHtlJFkWtAWIo/edit?gid=951914791#gid=951914791"
                target="_blank"
                title="cliquer pour voir le planning"
                aria-label="Voir le planning annuel"
            >
                planning
                <br/>
                annuel
            </a>
            <h3 id="calendar-title" role="heading" aria-level="3">Calendrier de Présence</h3>
            <p id="date-range-display" style="font-size: 14px; color: #666;"></p>
            <table role="table" aria-label="Calendrier de présence">
                <thead>
                    <tr>
                        <th scope="col">Date</th>
                        <th scope="col">Absent</th>
                        <th scope="col">Présent</th>
                    </tr>
                </thead>
                <tbody id="calendar-body">
                    <!-- Calendar rows will be injected here -->
                </tbody>
            </table>
            <button onclick="submitAttendance()" aria-label="Soumettre les présences">Soumettre</button>
        </div>
    </div>

    <script>
        "use strict";

        // ==================== CONSTANTS ====================
        const API_URL = "https://sheetdb.io/api/v1/x0mpyfueup16n";

        const MONTHS = {
            "janvier": "01",
            "février": "02",
            "mars": "03",
            "avril": "04",
            "mai": "05",
            "juin": "06",
            "juillet": "07",
            "août": "08",
            "septembre": "09",
            "octobre": "10",
            "novembre": "11",
            "décembre": "12"
        };

        const DAYS = {
            SUNDAY: 0,
            WEDNESDAY: 3
        };

        const MONTHS_INDEX = {
            NOVEMBER: 10,
            DECEMBER: 11,
            APRIL: 3
        };

        const ATTENDANCE_VALUES = {
            ABSENT: 'absent',
            PRESENT: 'présent',
            EMPTY: ''
        };

        const TOAST_DURATION = 4000;

        // ==================== STATE MANAGEMENT ====================
        let hasUnsavedChanges = false;

        // ==================== UTILITY FUNCTIONS ====================

        /**
         * Show a toast notification
         * @param {string} message - The message to display
         * @param {string} type - Toast type: 'success', 'error', 'warning', 'info'
         */
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'polite');
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => toast.remove(), 300);
            }, TOAST_DURATION);
        }

        /**
         * Set loading state for a button
         * @param {HTMLButtonElement} button - The button element
         * @param {boolean} isLoading - Loading state
         */
        function setButtonLoading(button, isLoading) {
            if (isLoading) {
                button.disabled = true;
                button.dataset.originalText = button.textContent;
                button.innerHTML = `${button.dataset.originalText}<span class="loading"></span>`;
            } else {
                button.disabled = false;
                button.textContent = button.dataset.originalText || button.textContent;
                delete button.dataset.originalText;
            }
        }

        /**
         * Format a date with leading zeros
         * @param {number} day - Day of the month
         * @returns {string} Formatted day
         */
        function formatDay(day) {
            return day < 10 ? `0${day}` : `${day}`;
        }

        /**
         * Parse French date string to date components
         * @param {string} dateString - Date string in French format
         * @returns {{day: string, month: string, year: string}}
         */
        function parseFrenchDate(dateString) {
            // Replace '1er' with '01' if present
            let normalizedDate = dateString.replace('1er', '01');

            const parts = normalizedDate.split(" ");
            let day = parts[1];
            const monthName = parts[2];
            const year = parts[3];

            // Add leading zero for single digit days > 1
            if (parseInt(day) < 10 && parseInt(day) > 1) {
                day = formatDay(parseInt(day));
            }

            const month = MONTHS[monthName];

            return { day, month, year };
        }

        /**
         * Format date components to dd/mm/yyyy
         * @param {{day: string, month: string, year: string}} dateComponents
         * @returns {string}
         */
        function formatDateKey(dateComponents) {
            return `${dateComponents.day}/${dateComponents.month}/${dateComponents.year}`;
        }

        /**
         * Get the next attendance day (Sunday or Wednesday)
         * @param {Date} startDate - Starting date
         * @returns {Date}
         */
        function getNextAttendanceDay(startDate) {
            const date = new Date(startDate);
            while (date.getDay() !== DAYS.SUNDAY && date.getDay() !== DAYS.WEDNESDAY) {
                date.setDate(date.getDate() + 1);
            }
            return date;
        }

        /**
         * Calculate end date based on current month
         * @param {Date} currentDate
         * @returns {Date}
         */
        function calculateEndDate(currentDate) {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            // From November onwards, show Q1 of next year
            if (month >= MONTHS_INDEX.NOVEMBER) {
                return new Date(year + 1, MONTHS_INDEX.APRIL, 1);
            }

            // Otherwise show until end of current year
            return new Date(year, MONTHS_INDEX.DECEMBER, 31);
        }

        /**
         * Advance to next attendance day
         * @param {Date} date - Current date
         * @returns {Date} Next attendance date
         */
        function advanceToNextAttendanceDay(date) {
            const newDate = new Date(date);
            if (newDate.getDay() === DAYS.SUNDAY) {
                newDate.setDate(newDate.getDate() + 3); // Sunday -> Wednesday
            } else {
                newDate.setDate(newDate.getDate() + 4); // Wednesday -> Sunday
            }
            return newDate;
        }

        /**
         * Format date range display
         * @param {Date} startDate
         * @param {Date} endDate
         * @returns {string}
         */
        function formatDateRange(startDate, endDate) {
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            const start = startDate.toLocaleDateString('fr-FR', options);
            const end = endDate.toLocaleDateString('fr-FR', options);
            return `Période : ${start} - ${end}`;
        }

        // ==================== CALENDAR GENERATION ====================

        /**
         * Create a calendar row for a specific date
         * @param {Date} date - The date for the row
         * @param {Object} userData - User attendance data
         * @returns {{row: HTMLTableRowElement, dateKey: string, exists: boolean}}
         */
        function createCalendarRow(date, userData) {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const formattedDate = date.toLocaleDateString('fr-FR', options).replace(/\b1\b/, '1er');

            const dateKey = date.toLocaleDateString('en-GB');
            const [day, month, year] = dateKey.split('/');
            const normalizedDateKey = `${day}/${month}/${year}`;

            // Check if date exists in user data
            const dateExists = typeof userData[normalizedDateKey] !== "undefined";

            // Get attendance status
            const presence = userData[normalizedDateKey]
                ? userData[normalizedDateKey].toLowerCase()
                : '';

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${formattedDate}</td>
                <td>
                    <input
                        type="radio"
                        name="attendance-${dateKey}"
                        value="${ATTENDANCE_VALUES.ABSENT}"
                        ${presence === ATTENDANCE_VALUES.ABSENT ? 'checked' : ''}
                        onchange="markUnsavedChanges()"
                        aria-label="Absent le ${formattedDate}"
                    >
                </td>
                <td>
                    <input
                        type="radio"
                        name="attendance-${dateKey}"
                        value="${ATTENDANCE_VALUES.PRESENT}"
                        ${presence === ATTENDANCE_VALUES.PRESENT ? 'checked' : ''}
                        onchange="markUnsavedChanges()"
                        aria-label="Présent le ${formattedDate}"
                    >
                </td>
            `;

            return { row, dateKey: normalizedDateKey, formattedDate, exists: dateExists };
        }

        /**
         * Generate the attendance calendar
         * @param {Object} userData - User data from API
         */
        function generateCalendar(userData) {
            const calendarBody = document.getElementById('calendar-body');
            calendarBody.innerHTML = '';

            const currentDate = new Date();
            const endDate = calculateEndDate(currentDate);
            const startDate = getNextAttendanceDay(currentDate);

            let currentDay = new Date(startDate);
            const missingDates = [];

            // Display date range
            const dateRangeDisplay = document.getElementById('date-range-display');
            dateRangeDisplay.textContent = formatDateRange(startDate, endDate);

            // Generate calendar rows
            while (currentDay <= endDate) {
                const { row, dateKey, formattedDate, exists } = createCalendarRow(currentDay, userData);

                if (!exists) {
                    missingDates.push(formattedDate);
                }

                calendarBody.appendChild(row);
                currentDay = advanceToNextAttendanceDay(currentDay);
            }

            // Alert about missing dates
            if (missingDates.length > 0) {
                showToast(
                    `Attention : ${missingDates.length} dates manquantes dans le planning. Contactez un responsable.`,
                    'warning'
                );
            }
        }

        // ==================== DATA SUBMISSION ====================

        /**
         * Collect attendance data from the calendar
         * @returns {Object} Attendance data keyed by date
         */
        function collectAttendanceData() {
            const rows = document.querySelectorAll('#calendar-body tr');
            const attendanceData = {};

            rows.forEach(row => {
                const dateText = row.cells[0].textContent;
                const { day, month, year } = parseFrenchDate(dateText);
                const formattedDate = formatDateKey({ day, month, year });

                const absentRadio = row.querySelector(`input[name="attendance-${formattedDate}"][value="${ATTENDANCE_VALUES.ABSENT}"]`);
                const presentRadio = row.querySelector(`input[name="attendance-${formattedDate}"][value="${ATTENDANCE_VALUES.PRESENT}"]`);

                if (absentRadio?.checked) {
                    attendanceData[formattedDate] = ATTENDANCE_VALUES.ABSENT;
                } else if (presentRadio?.checked) {
                    attendanceData[formattedDate] = ATTENDANCE_VALUES.PRESENT;
                } else {
                    attendanceData[formattedDate] = ATTENDANCE_VALUES.EMPTY;
                }
            });

            return attendanceData;
        }

        /**
         * Mark that there are unsaved changes
         */
        function markUnsavedChanges() {
            hasUnsavedChanges = true;
        }

        // ==================== API FUNCTIONS ====================

        /**
         * Submit email and fetch user data
         */
        async function submitEmail() {
            const emailInput = document.getElementById('email');
            const email = emailInput.value.trim();

            if (!email) {
                showToast('Veuillez entrer un email valide.', 'error');
                return;
            }

            const button = event.target;
            setButtonLoading(button, true);

            try {
                const url = `${API_URL}/search?Email=${encodeURIComponent(email)}`;

                const response = await fetch(url, {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                        "Cache-Control": "no-cache"
                    }
                });

                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();

                if (data.length > 0) {
                    const user = data[0];
                    localStorage.setItem('userEmail', email);
                    localStorage.setItem('userName', user.Nom);

                    document.getElementById('step1').style.display = 'none';
                    document.getElementById('step2').style.display = 'block';
                    document.querySelector('#calendar-title').textContent = `Calendrier de Présence de : ${user.Nom}`;

                    generateCalendar(user);
                    showToast(`Bienvenue ${user.Nom} !`, 'success');
                } else {
                    showToast("Utilisateur non trouvé. Vérifiez votre email.", 'error');
                }
            } catch (error) {
                console.error('Erreur lors de la récupération des données :', error);
                showToast(`Erreur: ${error.message}`, 'error');
            } finally {
                setButtonLoading(button, false);
            }
        }

        /**
         * Submit attendance data
         */
        async function submitAttendance() {
            const email = localStorage.getItem('userEmail');

            if (!email) {
                showToast('Session expirée. Veuillez vous reconnecter.', 'error');
                return;
            }

            const button = event.target;
            setButtonLoading(button, true);

            try {
                const attendanceData = collectAttendanceData();

                const response = await fetch(`${API_URL}/Email/${encodeURIComponent(email)}`, {
                    method: "PATCH",
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'
                    },
                    body: JSON.stringify({
                        data: attendanceData
                    })
                });

                if (response.ok) {
                    hasUnsavedChanges = false;
                    showToast("Données enregistrées avec succès !", 'success');
                } else {
                    const errorText = await response.text();
                    throw new Error(`Erreur ${response.status}: ${errorText}`);
                }
            } catch (error) {
                console.error('Erreur lors de la mise à jour :', error);
                showToast(`Erreur lors de l'enregistrement: ${error.message}`, 'error');
            } finally {
                setButtonLoading(button, false);
            }
        }

        // ==================== EVENT LISTENERS ====================

        // Warn before leaving page with unsaved changes
        window.addEventListener('beforeunload', (event) => {
            if (hasUnsavedChanges) {
                event.preventDefault();
                event.returnValue = 'Vous avez des modifications non enregistrées. Voulez-vous vraiment quitter ?';
                return event.returnValue;
            }
        });

        // Allow Enter key to submit email
        document.addEventListener('DOMContentLoaded', () => {
            const emailInput = document.getElementById('email');
            emailInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    submitEmail();
                }
            });
        });
    </script>
</body>
</html>
